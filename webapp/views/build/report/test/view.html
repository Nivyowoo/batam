<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Build And Test Automation Management</title>

    <!-- Bootstrap -->
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="../../../../css/jquery.dataTables.min.css">
  	<style>
  	dt:first-letter {
  	    text-transform:capitalize;
  	}
  	</style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">Build And Test Automation Management</a>
        </div>
        <ul class="nav navbar-nav">
            <li><a href="/">Builds</a></li>
        </ul>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="page-header" style="margin-top:75px">
          <h1>Test Report</h1>
          <a href="/{{build_id}}">{{build_name}}</a> / <a href="/{{build_id}}/report/{{report_id}}">{{report_name}}</a>
        </div>
      </div>
      <div class="row">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">
              <span style="padding-left:50px"><strong><a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" id="header_name"></a></strong></span> 
            </h3>
          </div>
          <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body">
              <div class="row">
                <div class="col-md-6">
                  <dl class="dl-horizontal">
                    <dt>Name</dt>
                    <dd id="test_name"></dd>

                    <dt>Date</dt>
                    <dd id="test_date"></dd>

                    <dt>Status</dt>
                    <dd id="test_status"><!-- <span class="label label-danger">error</span> --></dd>

                    <dt>Time</dt>
                    <dd id="test_time"></dd>

                    <dt>Regression</dt>
                    <dd id="test_regression"></dd>
               
                  </dl>
                </div>
                <div class="col-md-6">
                  <dl class="dl-horizontal" id="dynamic_fields">

                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row well">
        <div class="col-md-12" id="test_log">
        </div><!-- /.col-md-12 -->
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../../../../js/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../../../js/bootstrap.min.js"></script>
    <script src="../../../../js/moment.min.js"></script>
	
	<script type="text/javascript" >
	function formatWithLabel(value, trend, threshold, isTime){
    	if(value <= threshold){
    		if(isTime){
    			value = durationToStr(value);
    		}
    		if(trend > 0){
    			return '<span class="label label-success">'+value+' <span class="glyphicon glyphicon-chevron-up"></span></span>';
    		}else if(trend < 0){
    			return '<span class="label label-success">'+value+' <span class="glyphicon glyphicon-chevron-down"></span></span>';
    		}else{
    			return '<span class="label label-success">'+value+' </span>';
    		}
    	}
    	if(value > 0){
    		if(isTime){
    			value = durationToStr(value);
    		}
    		if(trend > 0){
    			return '<span class="label label-danger">'+value+' <span class="glyphicon glyphicon-chevron-up"></span></span>';
    		}else if(trend < 0){
    			return '<span class="label label-warning">'+value+' <span class="glyphicon glyphicon-chevron-down"></span></span>';
    		}else{
    			return '<span class="label label-warning">'+value+' </span>';
    		}
    	}else{
    		console.log("An unexpected error happenned");
    	}
    }
	function durationToStr (milliseconds) {
		var result = '';
        var temp = Math.floor(milliseconds / 1000);
    
        var days = Math.floor((temp %= 31536000) / 86400);
        if (days) {
        	result += days + ' d ';
        }
        var hours = Math.floor((temp %= 86400) / 3600);
        if (hours) {
        	result += hours + ' h ';
        }
        var minutes = Math.floor((temp %= 3600) / 60);
        if (minutes) {
        	result += minutes + ' m ';
        }
        var seconds = temp % 60;
        if (seconds) {
        	result += seconds + ' sec ';
        }
        return result; 
    }	
    $(document).ready(function(){
	    var criteriasIds = [];
	    var table;
	    var graph = 'status';
	    
  		// Initial fetch
    	$.getJSON('/api/tests/{{test_id}}', function(response){
	      	$('#header_name').html(response.test.name);
	      	$('#test_name').html(response.test.name);
	      	var date = response.test.date == undefined ? 'n/a' : moment(response.test.date).format('MMM Do YYYY, h:mm:ss a');
	      	$('#test_date').html(date);
	      	if(response.test.status == null){
	    		$('#test_status').html('<span class="label label-default">N/A</span>');	
	    	}else{
	    		$('#test_status').html(response.test.status);
	    	}
	      	var time = response.test.time == undefined ? 'n/a' : response.test.time;
	      	$('#test_time').html(time);
	      	var regression = response.test.regression == undefined ? 'n/a' : response.test.regression;
	      	$('#test_regression').html(regression);
	      	
	      	var dynamicFields = '';
	      	for(var field in response.test){
	      		console.log(field);
	      		if(field != '_id' &&
	      				field != 'report_id' &&
	      				field != 'name' &&
	      				field != 'date' &&
	      				field != 'status' &&
	      				field != 'time' &&
	      				field != 'regression' &&
	      				field != 'log'){
	      			if(field == 'duration'){
	      				dynamicFields += '<dt>'+field+'</dt>'+
                    	'<dd>'+formatWithLabel(response.test[field], 0, 1000, true)+'</dd>';
	      			}else{
	      				dynamicFields += '<dt>'+field+'</dt>'+
                    	'<dd>'+response.test[field]+'</dd>';
	      			}
	      		}
	      	}
	      	$('#dynamic_fields').html(dynamicFields);
	      	
	      	$('#test_log').html(response.test.log);
	    }).error(function(){
	    	//TODO Handle error better
	    	alert("error while fetching /api/tests/{{test_id}}"); 
	    }).fail(function(){
	    	//TODO Handle error better
	    	alert("fail while fetching /api/tests/{{test_id}}"); 
	    });	
	});
    </script>
	
  </body>
</html>